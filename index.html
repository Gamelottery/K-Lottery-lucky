<!DOCTYPE html>
<html lang="my">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bet Game</title>
  <style>
    body { font-family:sans-serif; }
    .hidden{ display:none; }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- RESULT POPUP -->
  <div id="resultPopup" class="hidden" 
       style="position:fixed;top:0;left:0;width:100%;height:100%;
              background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999">
    <div id="popupBox" 
         style="background:#ff6f3c;border-radius:14px;padding:20px 16px;text-align:center;width:300px;position:relative;color:#fff;">
      <div style="background:#fff;border-radius:50%;width:70px;height:70px;margin:0 auto;display:flex;align-items:center;justify-content:center;">
        <img id="popupIcon" src="" style="width:40px;height:40px"/>
      </div>
      <h3 id="popupTitle" style="margin:10px 0;font-size:18px;font-weight:700"></h3>
      <div id="popupNumber" style="font-size:28px;font-weight:700">0</div>
      <div id="popupBet" style="font-size:16px;margin:6px 0;color:#ffe600"></div>
      <div id="popupAmount" style="font-size:20px;margin:10px 0 20px 0">Ks 0</div>
      <button onclick="closeResultPopup()" 
              style="background:#fff;color:#ff6f3c;border:none;padding:8px 20px;border-radius:8px;font-weight:600">OK</button>
    </div>
  </div>

  <div id="betResult" class="hidden"></div>

<script>
let users = {};
let currentUser = null;

function saveAll(){ localStorage.setItem("users",JSON.stringify(users)); }
function updateUserInfo(){} // placeholder
function renderAdminLists(){} // placeholder

function resolveRound(){
  const rnd = Math.floor(Math.random()*10);
  const resultType = rnd <= 4 ? 'small' : 'big';

  Object.keys(users).forEach(u=>{
    const userObj = users[u];
    const betObj = userObj.currentPendingBet;
    if(!betObj) return;

    userObj.balance -= betObj.amount;
    let resultText = '';
    let winAmount = 0;

    if(betObj.type === 'number'){
      if(betObj.value === rnd){
        winAmount = Math.floor(betObj.amount * 9.5);
        userObj.balance += winAmount;
        resultText = `Win +${winAmount}`;
      } else {
        resultText = `Lose -${betObj.amount}`;
      }
    } else if(betObj.type === resultType){
      winAmount = Math.floor(betObj.amount * 1.95);
      userObj.balance += winAmount;
      resultText = `Win +${winAmount}`;
    } else {
      resultText = `Lose -${betObj.amount}`;
    }

    if(!userObj.history) userObj.history = [];
    userObj.history.unshift({ 
      time: new Date().toLocaleTimeString(), 
      bet: betObj.type + (betObj.type==='number'?' '+betObj.value:''), 
      amount: betObj.amount, 
      resultNum: rnd, 
      resultText 
    });
    if(userObj.history.length > 200) userObj.history.length = 200;
    delete userObj.currentPendingBet;

    // show popup only for current login user
    if(currentUser && currentUser.username === u){
      const popup = document.getElementById("resultPopup");
      const popupBox = document.getElementById("popupBox");
      const popupIcon = document.getElementById("popupIcon");
      const popupTitle = document.getElementById("popupTitle");
      const popupNumber = document.getElementById("popupNumber");
      const popupBet = document.getElementById("popupBet");
      const popupAmount = document.getElementById("popupAmount");

      popupNumber.innerText = "á€‘á€½á€€á€ºá€á€±á€¬á€‚á€á€”á€ºá€¸ âœ " + rnd;
      popupBet.innerText = "á€™á€„á€ºá€¸á€˜á€€á€ºá€á€„á€ºá€‘á€¬á€¸á€á€Šá€º âœ " + (betObj.type==='number'? betObj.value : betObj.type);

      popup.classList.remove("hidden");

      if(winAmount > 0){
        popupBox.style.background = "#ff6f3c"; // á€¡á€”á€­á€¯á€„á€º â†’ á€œá€­á€™á€¹á€™á€±á€¬á€º
        popupIcon.src = "https://cdn-icons-png.flaticon.com/512/190/190411.png";
        popupTitle.innerText = "ğŸ‰ á€á€„á€·á€ºá€¡á€”á€­á€¯á€„á€ºá€›á€•á€«á€á€Šá€º";
        popupAmount.innerText = "Win: Ks " + winAmount.toLocaleString();
      } else {
        popupBox.style.background = "#555"; // á€¡á€›á€¾á€¯á€¶á€¸ â†’ á€™á€®á€¸á€á€­á€¯á€¸
        popupIcon.src = "https://cdn-icons-png.flaticon.com/512/1828/1828843.png";
        popupTitle.innerText = "âŒ á€á€„á€·á€ºá€¡á€›á€¾á€¯á€¶á€¸á€–á€¼á€…á€ºá€•á€«á€á€Šá€º";
        popupAmount.innerText = "Lose: Ks " + betObj.amount.toLocaleString();
      }
    }
  });

  saveAll();
  document.getElementById('betResult').classList.remove('hidden');
  document.getElementById('betResult').innerText = `Result: ${rnd} â†’ ${resultType}`;
  updateUserInfo();
  renderAdminLists();
}

function closeResultPopup(){
  document.getElementById("resultPopup").classList.add("hidden");
}
</script>
</body>
</html>
